@using PagedList.Mvc;
@using PagedList;
@model IPagedList<DoAn_web.Models.Product>

@{
    ViewBag.Title = "Quản lý Sản phẩm";
    Layout = "~/Areas/Admin2026/Views/Shared/_LayoutAdmin.cshtml";

    // 🔥 FIX LỖI CS1503: Định nghĩa tham số lọc an toàn
    var routeValues = new RouteValueDictionary(new
    {
        searchString = ViewBag.CurrentFilter,
        minPrice = ViewBag.MinFilter,
        maxPrice = ViewBag.MaxFilter
    });

    // 🔥 ĐÃ LOẠI BỎ PagerOptions để fix lỗi CS0117
}

<style>
    /* ------------------------------------------------------------------- */
    /* CSS CHO PHÂN TRANG & BỘ LỌC (PURE CSS/FLEXBOX) */
    /* ------------------------------------------------------------------- */
    /* Lưu ý: PagedList mặc định dùng UL/LI. Dùng CSS này để làm cho nó đẹp hơn */
    .pagination-container-fix {
        display: flex;
        justify-content: space-between; /* Căn lề hai bên */
        align-items: center;
        margin-top: 20px;
    }

        .pagination-container-fix ul.pagination {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden;
        }

            .pagination-container-fix ul.pagination li {
                margin: 0;
                padding: 0;
            }

                .pagination-container-fix ul.pagination li a, .pagination-container-fix ul.pagination li span {
                    display: block;
                    padding: 8px 12px;
                    text-decoration: none;
                    color: #333;
                    border-left: 1px solid #ccc;
                    transition: background-color 0.2s;
                }

                .pagination-container-fix ul.pagination li:first-child a, .pagination-container-fix ul.pagination li:first-child span {
                    border-left: none;
                }

                .pagination-container-fix ul.pagination li a:hover {
                    background-color: #f0f0f0;
                }
                /* PagedList dùng thẻ SPAN cho trang hiện tại */
                .pagination-container-fix ul.pagination li span {
                    background-color: #007bff;
                    color: white;
                    pointer-events: none;
                }


    /* CSS CHO KHỐI FILTER (Giữ nguyên) */
    .app-filter-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: flex-end;
        padding: 15px;
        border: 1px solid #eee;
        border-radius: 6px;
        background-color: #f9f9f9;
        margin-bottom: 20px;
    }

    .app-filter-item {
        display: flex;
        flex-direction: column;
    }

        .app-filter-item input, .app-filter-item button, .app-filter-item a {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-decoration: none;
            font-size: 14px;
        }

        .app-filter-item input {
            width: 100%;
        }

        .app-filter-item button, .app-filter-item a {
            text-align: center;
        }

    /* CSS FIX ỔN ĐỊNH BẢNG (Giữ nguyên) */
    .product-description-cell {
        padding: 10px;
        max-width: 250px;
        overflow: hidden;
    }

    .product-description-content {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .action-buttons-cell {
        padding: 10px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        min-width: 300px;
        white-space: nowrap;
    }

        .action-buttons-cell a, .action-buttons-cell button {
            margin-right: 5px;
        }
</style>


@* --- BỘ LỌC (FORM) --- *@
@using (Html.BeginForm("Index", "Products", FormMethod.Get, new { @class = "app-filter-container" }))
{
    <div class="app-filter-item" style="flex-grow: 2; min-width: 200px;">
        <label>Tìm kiếm (Tên/Mô tả)</label>
        <input type="text" name="searchString" value="@ViewBag.CurrentFilter" />
    </div>

    <div class="app-filter-item" style="width: 100px;">
        <label>Giá từ</label>
        <input type="number" name="minPrice" value="@ViewBag.MinFilter" min="0" step="1000000" />
    </div>

    <div class="app-filter-item" style="width: 100px;">
        <label>Giá đến</label>
        <input type="number" name="maxPrice" value="@ViewBag.MaxFilter" min="0" step="1000000" />
    </div>

    <div class="app-filter-item">
        <label>&nbsp;</label>
        <button type="submit" style="background-color: #007bff; color: white;">Lọc</button>
    </div>

    <div class="app-filter-item">
        <label>&nbsp;</label>
        @Html.ActionLink("Reset", "Index", null, new { style = "background-color: #f0f0f0; color: #333; border: 1px solid #ccc; padding: 8px; line-height: 1.2;" })
    </div>

    <div class="app-filter-item" style="margin-left: auto;">
        <label>&nbsp;</label>
        @Html.ActionLink("Thêm mới", "Create", null, new { style = "background-color: #28a745; color: white; border: none; padding: 8px;" })
    </div>
}


@* --- BẢNG DỮ LIỆU SẢN PHẨM --- *@
<div>
    @if (TempData["Error"] != null)
    {
        <div style="color: red; padding: 10px; border: 1px solid red; margin-bottom: 15px;">
            @TempData["Error"]
        </div>
    }

    <table style="width: 100%; border-collapse: collapse;">
        <thead style="background-color: #343a40; color: white;">
            <tr>
                <th style="padding: 10px; ">Ảnh</th>
                <th style="padding: 10px;">Tên sản phẩm</th>
                <th style="padding: 10px;" class="product-description-cell">Mô tả</th>
                <th style="padding: 10px;">Giá bán</th>
                <th style="padding: 10px; white-space: nowrap">Tồn kho</th>
                <th style="padding: 10px; white-space: nowrap">Đã bán</th>
                <th style="padding: 10px; white-space: nowrap">Danh mục</th>
                <th style="padding: 10px;" class="action-buttons-cell">Hành động</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px;"><img src="@Url.Content(item.ProductImage)" style="width: 50px; height: 50px; object-fit: cover;" /></td>
                    <td style="padding: 10px; font-weight: bold;">@Html.DisplayFor(modelItem => item.ProductName)</td>

                    <td class="product-description-cell">
                        <div class="product-description-content">
                            @Html.DisplayFor(modelItem => item.ProductDecription)
                        </div>
                    </td>

                    <td style="padding: 10px; color: #d9534f;">@(item.ProductPrice.ToString("N0") + " đ")</td>

                    <td style="padding: 10px; color: @(item.Quantity == 0 ? "red" : (item.Quantity <= 5 ? "orange" : "blue")); font-weight: bold;">
                        @item.Quantity
                    </td>
                    <td style="padding: 10px; color: green;">
                        @item.SoldQuantity
                    </td>

                    <td style="padding: 10px;">@Html.DisplayFor(modelItem => item.Category.CategoryName)</td>

                    <td class="action-buttons-cell">
                        <a href="@Url.Action("Index", "ProductDetail", new { id = item.ProductID })" class="btn btn-info btn-sm">
                            <i class="fa fa-cog"></i> Cấu hình
                        </a>
                        @Html.ActionLink("Sửa", "Edit", new { id = item.ProductID }, new { style = "background-color: #f0ad4e; color: white; padding: 5px 10px; border-radius: 4px;" })
                        @Html.ActionLink("Chi tiết", "Details", new { id = item.ProductID }, new { style = "background-color: #5bc0de; color: white; padding: 5px 10px; border-radius: 4px;" })

                        @if (item.SoldQuantity == 0)
                        {
                            @Html.ActionLink("Xóa", "Delete", new { id = item.ProductID }, new { style = "background-color: #d9534f; color: white; padding: 5px 10px; border-radius: 4px;" })
                        }
                        else
                        {
                            <button type="button" disabled style="background-color: #ccc; color: #666; padding: 5px 10px; border-radius: 4px; border: none; cursor: not-allowed; font-size: 14px;">
                                Xóa
                            </button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@* KHỐI PHÂN TRANG (ĐÃ FIX LỖI) *@
<div class="pagination-container-fix">

    <div style="color: #6c757d; font-size: 14px;">
        Trang @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) trên @Model.PageCount
        (@Model.TotalItemCount mục)
    </div>

    @* Gọi PagedListPager mà không cần PagerOptions phức tạp *@
    @Html.PagedListPager(Model, page => Url.Action("Index",
        new
            {
                page = page,
                searchString = routeValues["searchString"],
                minPrice = routeValues["minPrice"],
                maxPrice = routeValues["maxPrice"]
            }
    ))
</div>