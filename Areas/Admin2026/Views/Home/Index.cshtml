@model DoAn_web.ViewModels.DashboardViewModel

@{
    ViewBag.Title = "Bảng điều khiển";
    Layout = "~/Areas/Admin2026/Views/Shared/_LayoutAdmin.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* 1. Layout Full Màn Hình (Không cuộn) */
    .dashboard-container {
        height: calc(100vh - 80px); /* Trừ đi chiều cao Header (ước lượng 80px) */
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding-bottom: 10px;
    }

    /* 2. Phần Thống kê (Cố định chiều cao) */
    .stats-section {
        flex: 0 0 auto;
    }

    /* 3. Phần Biểu đồ (Tự giãn để lấp đầy khoảng trống còn lại) */
    .charts-section {
        flex: 1 1 auto;
        min-height: 0; /* Quan trọng: Cho phép thu nhỏ nếu màn hình bé */
        padding-top: 15px;
    }

    /* 4. Class cho số to (dùng cho 3 ô còn lại) */
    .stat-value-big {
        font-size: 1.8rem;
        font-weight: 700;
    }

    .chart-container {
        position: relative;
        height: 100%;
        width: 100%;
    }
</style>

<div class="container-fluid py-3 dashboard-container">

    <div class="row g-3 stats-section">

        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white shadow-sm border-0 h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div style="overflow: hidden; padding-right: 5px;">
                            <p class="mb-1 opacity-75 text-uppercase fw-bold small">Tổng doanh thu</p>

                            <div class="fw-bold text-nowrap" style="font-size: 1.3rem;" title="@String.Format("{0:N0}", Model.TotalRevenue)">
                                @String.Format("{0:N0}", Model.TotalRevenue) <small>₫</small>
                            </div>
                        </div>
                        <i class="fas fa-sack-dollar fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card bg-success text-white shadow-sm border-0 h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75 text-uppercase fw-bold small">Đơn hàng</p>
                            <div class="stat-value-big">@Model.TotalOrders</div>
                        </div>
                        <i class="fas fa-shopping-cart fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card bg-info text-white shadow-sm border-0 h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75 text-uppercase fw-bold small">Khách hàng</p>
                            <div class="stat-value-big">@Model.TotalCustomers</div>
                        </div>
                        <i class="fas fa-users fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card bg-warning text-dark shadow-sm border-0 h-100">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="mb-1 opacity-75 text-uppercase fw-bold small">Sản phẩm</p>
                            <div class="stat-value-big">@Model.TotalProducts</div>
                        </div>
                        <i class="fas fa-box-open fa-3x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3 charts-section">
        <div class="col-lg-8 h-100">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-2">
                    <h6 class="m-0 fw-bold text-primary"><i class="fas fa-chart-line me-2"></i>Biểu đồ Doanh thu</h6>
                </div>
                <div class="card-body chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4 h-100">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-white py-2">
                    <h6 class="m-0 fw-bold text-success"><i class="fas fa-chart-pie me-2"></i>Lượng bán theo Danh mục</h6>
                </div>
                <div class="card-body d-flex justify-content-center align-items-center" style="position: relative;">
                    <div style="height: 90%; width: 100%; display: flex; justify-content: center;">
                        <canvas id="categoryPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CẤU HÌNH BIỂU ĐỒ DOANH THU ---
    var ctxRevenue = document.getElementById('revenueChart').getContext('2d');
    var revenueChart = new Chart(ctxRevenue, {
        type: 'line',
        data: {
            labels: @Html.Raw(Json.Encode(ViewBag.ChartLabels)),
            datasets: [{
                label: 'Doanh thu (VNĐ)',
                data: @Html.Raw(Json.Encode(ViewBag.ChartData)),
                backgroundColor: 'rgba(54, 162, 235, 0.2)', // Màu nền xanh nhạt
                borderColor: 'rgba(54, 162, 235, 1)',     // Màu đường viền xanh
                borderWidth: 2,
                tension: 0.4, // Độ cong mềm mại
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // QUAN TRỌNG: Để biểu đồ tự giãn theo chiều cao
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        // Định dạng tiền tệ trục Y (Ví dụ: 1.000.000 đ)
                        callback: function(value) { return value.toLocaleString('vi-VN'); }
                    }
                }
            },
            plugins: {
                legend: { display: false } // Ẩn chú thích cho gọn
            }
        }
    });

    // --- 2. CẤU HÌNH BIỂU ĐỒ TRÒN (Sản phẩm bán ra) ---
    // Kiểm tra dữ liệu an toàn để tránh lỗi
    var pieLabels = @Html.Raw(Json.Encode(ViewBag.PieLabels ?? new List<string>()));
    var pieData = @Html.Raw(Json.Encode(ViewBag.PieData ?? new List<int>()));

    if(pieLabels.length > 0){
        var ctxPie = document.getElementById('categoryPieChart').getContext('2d');
        var categoryPieChart = new Chart(ctxPie, {
            type: 'doughnut', // Kiểu vành khuyên
            data: {
                labels: pieLabels,
                datasets: [{
                    label: 'Đã bán',
                    data: pieData,
                    backgroundColor: [
                        '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b', '#858796', '#20c997', '#6610f2'
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Tự giãn
                plugins: {
                    legend: {
                        position: 'bottom', // Chú thích nằm dưới
                        labels: { padding: 20, usePointStyle: true }
                    },
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                let value = context.raw || 0;
                                return label + ': ' + value + ' sản phẩm';
                            }
                        }
                    }
                },
                layout: {
                    padding: 10
                }
            }
        });
    }
</script>